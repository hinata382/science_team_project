<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš›ï¸ ë³´ì–´ ëª¨í˜• ì›ì†Œ í€´ì¦ˆ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the app */
        #bohrCanvas {
            border-radius: 1rem;
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(145deg, #e0e7ff, #ffffff);
            transition: all 0.3s ease-in-out;
        }
        
        /* ì˜¤ë¥˜ ìˆ˜ì •: @apply ëŒ€ì‹  í‘œì¤€ CSS ì†ì„±ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.
           (flex, p-3, rounded-xl, shadow-lg, transition duration-300, hover:scale-[1.02]ì— í•´ë‹¹)
        */
        .score-box {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            transition: all 300ms ease-in-out;
        }
        .score-box:hover {
            transform: scale(1.02);
        }

        .correct {
            border: 3px solid #10b981; /* green-500 */
        }
        .incorrect {
            border: 3px solid #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <!-- í™ˆ ë²„íŠ¼ (ë©”ì¸ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°) -->
    <a href="main_menu.html" class="absolute top-4 left-4 text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8m-1-12a9 9 0 019 9 9 9 0 01-9 9 9 9 0 01-9-9 9 9 0 019-9z"></path></svg>
        ë©”ì¸ ë©”ë‰´
    </a>

    <div class="w-full max-w-xl bg-white shadow-2xl rounded-3xl p-6 md:p-8 space-y-6">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 text-center">
            âš›ï¸ ë³´ì–´ ëª¨í˜• ì›ì†Œ í€´ì¦ˆ
        </h1>
        
        <!-- Game Stats -->
        <div class="flex justify-around gap-4 text-center">
            <div class="score-box bg-indigo-50 text-indigo-700 w-1/2">
                <span class="text-lg font-bold">ì ìˆ˜: </span>
                <span id="scoreDisplay" class="text-2xl ml-2 font-extrabold">0</span>
            </div>
            <div class="score-box bg-gray-50 text-gray-700 w-1/2">
                <span class="text-lg font-bold">ë¼ìš´ë“œ: </span>
                <span id="roundDisplay" class="text-2xl ml-2 font-extrabold">0</span>
            </div>
        </div>

        <!-- Question Area -->
        <div id="questionArea" class="space-y-4">
            <h2 id="questionText" class="text-xl font-semibold text-center text-gray-700">ê²Œì„ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!</h2>
            
            <!-- Canvas for Bohr Model -->
            <div class="flex justify-center items-center p-4 bg-white rounded-xl">
                <canvas id="bohrCanvas" width="350" height="350" class="border-4 border-gray-200"></canvas>
            </div>
            
            <!-- Answer Input -->
            <div id="answerInputGroup" class="flex gap-3 pt-2 hidden">
                <input type="text" id="answerInput" placeholder="ì›ì†Œ ê¸°í˜¸ ì…ë ¥ (ì˜ˆ: C, O, Na)" class="flex-grow p-3 border-2 border-gray-300 rounded-lg text-lg uppercase focus:outline-none focus:border-indigo-500 transition duration-150" maxlength="2" onkeydown="if(event.key === 'Enter') checkAnswer()">
                <button onclick="checkAnswer()" id="submitButton" class="bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-150 shadow-md">
                    ì •ë‹µ í™•ì¸
                </button>
            </div>
            
            <!-- Start/Next Button -->
            <button onclick="startGame()" id="startButton" class="w-full bg-green-500 text-white p-4 rounded-lg font-extrabold text-xl hover:bg-green-600 transition duration-150 shadow-lg">
                ê²Œì„ ì‹œì‘
            </button>
        </div>

        <!-- Feedback & Reveal Area -->
        <div id="feedback" class="text-center font-bold text-lg pt-4"></div>
        
        <!-- Element Details (Hidden until answer is revealed) -->
        <div id="elementReveal" class="p-4 bg-indigo-50 rounded-xl border-l-4 border-indigo-500 hidden">
            <h3 class="text-xl font-bold text-indigo-800 mb-2">ì›ì†Œ ì •ë³´ (ì •ë‹µ)</h3>
            <p id="revealDetails" class="text-gray-700"></p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5001/api/element/';
        
        // í€´ì¦ˆì— ì‚¬ìš©í•  ì›ì†Œ ëª©ë¡ (H, Lië¶€í„° Krê¹Œì§€ ì¼ë¶€)
        const QUIZ_ELEMENTS = [
            'H', 'He', 'Li', 'Be', 'B', 'C', 'N', 'O', 'F', 'Ne',
            'Na', 'Mg', 'Al', 'Si', 'P', 'S', 'Cl', 'Ar',
            'K', 'Ca', 'Fe', 'Cu', 'Zn', 'Br', 'Kr'
        ];

        let score = 0;
        let round = 0;
        let currentElementData = null;
        let isGameRunning = false;

        const canvas = document.getElementById('bohrCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width;
        const H = canvas.height;
        const centerX = W / 2;
        const centerY = H / 2;
        
        // DOM ìš”ì†Œ ìºì‹œ
        const scoreDisplay = document.getElementById('scoreDisplay');
        const roundDisplay = document.getElementById('roundDisplay');
        const questionText = document.getElementById('questionText');
        const answerInput = document.getElementById('answerInput');
        const submitButton = document.getElementById('submitButton');
        const startButton = document.getElementById('startButton');
        const answerInputGroup = document.getElementById('answerInputGroup');
        const feedback = document.getElementById('feedback');
        const elementReveal = document.getElementById('elementReveal');
        const revealDetails = document.getElementById('revealDetails');


        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        // ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì´ìš©í•œ API í˜¸ì¶œ í•¨ìˆ˜ (app.pyì™€ì˜ í†µì‹ )
        async function fetchWithRetry(url, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        if (response.status === 404) throw new Error("Element data not found (404)");
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (error.message.includes("404")) throw error;
                    // ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ì—°ê²° ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error(`Failed to fetch ${url} after ${maxRetries} attempts.`);
        }


        // --- ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ---

        function drawBohrModel(electronShells, totalElectrons, elementSymbol, isRevealed = false) {
            ctx.clearRect(0, 0, W, H);
            
            // í•µ(ì›ì ë²ˆí˜¸) ê·¸ë¦¬ê¸°
            ctx.beginPath();
            ctx.arc(centerX, centerY, 20, 0, Math.PI * 2);
            ctx.fillStyle = isRevealed ? '#10b981' : '#ef4444'; 
            ctx.fill();
            ctx.strokeStyle = '#991b1b';
            ctx.lineWidth = 2;
            ctx.stroke();

            // í•µ ë‚´ë¶€ í…ìŠ¤íŠ¸ 
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(totalElectrons, centerX, centerY);
            
            const maxRadius = 150;
            const shellCount = electronShells.length;

            // ê»ì§ˆ ê·¸ë¦¬ê¸°
            electronShells.forEach((electrons, index) => {
                const shellIndex = index + 1; 
                const radius = (maxRadius / shellCount) * shellIndex; 
                
                // ê¶¤ë„ ê·¸ë¦¬ê¸°
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.strokeStyle = '#9ca3af'; 
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.stroke();
                ctx.setLineDash([]);

                if (electrons === 0) return;

                // ì „ì ê·¸ë¦¬ê¸°
                for (let i = 0; i < electrons; i++) {
                    const angle = (i / electrons) * Math.PI * 2;
                    const x = centerX + radius * Math.cos(angle);
                    const y = centerY + radius * Math.sin(angle);
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, Math.PI * 2);
                    ctx.fillStyle = '#1e40af';
                    ctx.fill();
                    ctx.strokeStyle = '#1e3a8a';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            });
        }
        
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë©”ì‹œì§€
        function drawInitialMessage(message) {
            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = '#6b7280';
            ctx.font = 'bold 20px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(message, centerX, centerY);
        }

        // --- ê²Œì„ ë¡œì§ í•¨ìˆ˜ ---

        /**
         * ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
         */
        function startGame() {
            score = 0;
            round = 0;
            isGameRunning = true;
            updateStats();
            
            startButton.onclick = loadNextQuestion;
            startButton.textContent = 'ë‹¤ìŒ ë¬¸ì œ ì‹œì‘';
            startButton.classList.replace('bg-green-500', 'bg-indigo-600');
            answerInputGroup.classList.remove('hidden');
            feedback.textContent = '';
            elementReveal.classList.add('hidden');
            answerInput.classList.remove('correct', 'incorrect');
            answerInput.disabled = false;
            submitButton.disabled = false;
            
            loadNextQuestion();
        }

        /**
         * ë‹¤ìŒ ë¬¸ì œë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
         */
        async function loadNextQuestion() {
            if (!isGameRunning) return;

            round++;
            updateStats();
            
            // UI ì´ˆê¸°í™”
            feedback.textContent = 'ì›ì†Œ ê¸°í˜¸ë¥¼ ì…ë ¥í•˜ê³  ì •ë‹µì„ í™•ì¸í•˜ì„¸ìš”.';
            elementReveal.classList.add('hidden');
            answerInput.value = '';
            answerInput.classList.remove('correct', 'incorrect');
            answerInput.disabled = false;
            submitButton.disabled = false;
            startButton.classList.add('hidden'); // 'ë‹¤ìŒ ë¬¸ì œ' ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            questionText.textContent = 'ì´ ë³´ì–´ ëª¨í˜•ì´ ë‚˜íƒ€ë‚´ëŠ” ì›ì†ŒëŠ” ë¬´ì—‡ì¼ê¹Œìš”?';
            
            try {
                // ë¬´ì‘ìœ„ ì›ì†Œ ì„ íƒ
                const randomIndex = Math.floor(Math.random() * QUIZ_ELEMENTS.length);
                const randomSymbol = QUIZ_ELEMENTS[randomIndex];

                // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const data = await fetchWithRetry(`${API_BASE_URL}${randomSymbol}`);
                currentElementData = data;
                
                // ë³´ì–´ ëª¨í˜• ê·¸ë¦¬ê¸°
                drawBohrModel(data.electron_shells, data.total_electrons, data.symbol);

            } catch (error) {
                console.error("Quiz Load Error:", error);
                drawInitialMessage('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜');
                questionText.textContent = `ì˜¤ë¥˜: ì„œë²„ ì—°ê²° ë˜ëŠ” ë°ì´í„° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (Console í™•ì¸)`;
                currentElementData = null;
                isGameRunning = false;
                startButton.textContent = 'ê²Œì„ ì¬ì‹œì‘';
                startButton.classList.replace('bg-indigo-600', 'bg-green-500');
                startButton.classList.remove('hidden');
            }
        }
        
        /**
         * ì‚¬ìš©ìì˜ ì •ë‹µì„ í™•ì¸í•©ë‹ˆë‹¤.
         */
        function checkAnswer() {
            if (!isGameRunning || !currentElementData || submitButton.disabled) return;

            const userAnswer = answerInput.value.trim().toUpperCase();
            const correctAnswer = currentElementData.symbol.toUpperCase();
            
            answerInput.disabled = true;
            submitButton.disabled = true;
            startButton.classList.remove('hidden'); // 'ë‹¤ìŒ ë¬¸ì œ' ë²„íŠ¼ í‘œì‹œ

            if (userAnswer === correctAnswer) {
                // ì •ë‹µ!
                score++;
                feedback.innerHTML = `<span class="text-green-600">ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! (${currentElementData.symbol})</span>`;
                answerInput.classList.add('correct');
                drawBohrModel(currentElementData.electron_shells, currentElementData.total_electrons, currentElementData.symbol, true);
            } else {
                // ì˜¤ë‹µ!
                feedback.innerHTML = `<span class="text-red-600">âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ì •ë‹µì€ ${currentElementData.symbol} (${currentElementData.name}) ì…ë‹ˆë‹¤.</span>`;
                answerInput.classList.add('incorrect');
            }
            
            updateStats();
            revealAnswerDetails();
        }

        /**
         * ì ìˆ˜ì™€ ë¼ìš´ë“œ ìˆ˜ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateStats() {
            scoreDisplay.textContent = score;
            roundDisplay.textContent = round;
        }

        /**
         * ì •ë‹µ ì›ì†Œì˜ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function revealAnswerDetails() {
            if (!currentElementData) return;
            
            elementReveal.classList.remove('hidden');
            revealDetails.innerHTML = `
                <p><strong>ì›ì ë²ˆí˜¸:</strong> ${currentElementData.total_electrons}</p>
                <p><strong>ì£¼ê¸°:</strong> ${currentElementData.period}ì£¼ê¸°, <strong>ì¡±:</strong> ${currentElementData.group}ì¡±</p>
                <p><strong>ì „ì ë°°ì¹˜:</strong> ${currentElementData.electron_shells.join(', ')}</p>
            `;
        }

        // ì´ˆê¸° ë¡œë“œ ì‹œ ìº”ë²„ìŠ¤ì— ì•ˆë‚´ ë©”ì‹œì§€ ê·¸ë¦¬ê¸°
        window.onload = () => {
            drawInitialMessage('ê²Œì„ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”!');
        };

    </script>
</body>
</html>